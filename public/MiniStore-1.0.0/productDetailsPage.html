<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | Thunder Store</title>
  <link rel="stylesheet" href="shoppingPageStyle.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <div id="loader" class="loader-overlay">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <div class="navbar">
      <div class="logo">
        <a href="index.html"><img src="../../images/logo.JPG" alt="Thunder Store" width="170px"></a>
      </div>
      <nav>
        <ul id="MenuItems">
          <li><a href="index.html">Home</a></li>
          <li><a href="shoppingPage.html">Products</a></li>
          <li><a href="">About</a></li>
          <li><a href="">Contact</a></li>
          <li><a href="userProfile.html">Profile</a></li>
        </ul>
      </nav>
      <a href="cart.html"><img src="../../images/cart.png" width="30px" height="30px"></a>
      <img src="images/menu.png" class="menu-icon" onclick="menutoggle()">
    </div>
  </div>

  <!-- Single Product -->
  <div class="small-container single-product">
    <div class="row">
      <div class="col-2">
        <img src="" width="100%" id="ProductImg" >
      </div>
      <div class="col-2" id="productDetails">
        <!-- Product details will be populated here -->
      </div>
    </div>
  </div>

  <!-- Related Products -->
  <div class="small-container">
    <div class="row row-2">
      <h2>Related Products</h2>
      
    </div>
    <div class="row" id="related-products">
      <!-- Related products will be populated here -->
    </div>
  </div>

  <!-- Footer -->
  <div id="footer-bottom">
    <div class="container">
      <div class="row d-flex flex-wrap justify-content-between">
        <div class="col-md-4 col-sm-6">
          <div class="Shipping d-flex">
            <p>We ship with:</p>
            <div class="card-wrap ps-2">
              <img src="images/dhl.png" alt="visa">
              <img src="images/shippingcard.png" alt="mastercard">
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6">
          <div class="payment-method d-flex">
            <p>Payment options:</p>
            <div class="card-wrap ps-2">
              <img src="images/visa.jpg" alt="visa">
              <img src="images/mastercard.jpg" alt="mastercard">
              <img src="images/paypal.jpg" alt="paypal">
            </div>
          </div>
        </div>
        <div class="col-md-4 col-sm-6">
          <div class="copyright">
            <p>© Copyright 2025 ThunderStore.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Menu toggle
    var MenuItems = document.getElementById("MenuItems");
    MenuItems.style.maxHeight = "0px";
    function menutoggle() {
      MenuItems.style.maxHeight = MenuItems.style.maxHeight === "0px" ? "200px" : "0px";
    }

    // Product gallery image switching
    var ProductImg = document.getElementById("ProductImg");
    var SmallImg = document.getElementsByClassName("small-img");

    for (let i = 0; i < SmallImg.length; i++) {
      SmallImg[i].onclick = function () {
        ProductImg.src = SmallImg[i].src;
      }
    }

    // Fetch and display product details
    async function fetchProductDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');

      if (!productId) {
        console.error('No product ID provided');
        return;
      }
      document.getElementById('loader').style.display = 'flex';
      try {
        const response = await fetch(`http://localhost:3000/items/search?item_id=${productId}`);
        const data = await response.json();

        if (data.items && data.items.length > 0) {
          const product = data.items[0];
          displayProductDetails(product);
          fetchRelatedProducts(product.category, product.item_id); // Load related products
        } else {
          console.error('Product not found');
        }
      } catch (error) {
        console.error('Error fetching product details:', error);
      }

    }

    function displayProductDetails(product) {
      document.title = `${product.item_name} | Thunder Store`;
      const productImg = document.getElementById('ProductImg');
      productImg.onerror = function () {
        this.onerror = null;
        this.src = '../../images/a1.JPG';
      };
      productImg.src = product.image || '../../images/a1.JPG';

      const detailsContainer = document.getElementById('productDetails');
      detailsContainer.innerHTML = `
        <p>Home / ${product.category}</p>
        <h1>${product.item_name}</h1>
        <h4>${
          product.discount_price
            ? `$${product.discount_price} <small><s>$${product.actual_price}</s></small>`
            : `$${product.actual_price}`
        }</h4>
        <div class="rating">
          ${getStarRating(product.item_rating)}
          <span>(${product.item_rating ? product.item_rating.toFixed(1) : 'No'} Rating)</span>
        </div>
        <input type="number" value="1" min="1">
        <a href="#" class="btn">Add To Cart</a>
        <h3>Product Details <i class="fa fa-indent"></i></h3>
        <br>
        <p>Seller: ${product.seller.store_name}</p>
        <p>Seller Rating: ${product.seller.rating ? product.seller.rating.toFixed(1) : 'No rating'}</p>
      `;
    }

    function getStarRating(rating) {
      if (!rating) return '';
      const fullStars = Math.floor(rating);
      const starsHtml = '★'.repeat(fullStars) + '☆'.repeat(5 - fullStars);
      return `<span class="stars">${starsHtml}</span>`;
    }

    // Fetch related products
    async function fetchRelatedProducts(category, current_id) {
      try {
        const response = await fetch(`http://localhost:3000/items/related?category=${encodeURIComponent(category)}&current_id=${current_id}`);
        const data = await response.json();

        const relatedContainer = document.getElementById("related-products");
        relatedContainer.innerHTML = data.map(item => `
          <div class="col-4">
            <a href="product-details.html?id=${item.item_id}">
              <img src="${item.image}" onerror="this.onerror=null;this.src='/images/a1.JPG';" />
              <h4>${item.item_name}</h4>
              <p>$${item.discount_price || item.actual_price}</p>
            </a>
          </div>
        `).join('');
      } catch (error) {
        console.error("Error loading related products:", error);
      }
      finally{
        document.getElementById('loader').style.display = 'none'; // Hide loader
      }
    }

    // Load product on page load
    document.addEventListener('DOMContentLoaded', fetchProductDetails);
    fetchProductDetails();
  </script>
</body>
</html>
