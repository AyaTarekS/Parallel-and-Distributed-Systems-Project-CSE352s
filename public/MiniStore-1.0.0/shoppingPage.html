<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products | Thunder Store</title>
    <link rel="stylesheet" href="shoppingPageStyle.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
      </div>
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <a href="index.html"><img src="../../images/logo.JPG" alt="Thunder Store" width="170px"></a>
            </div>
            <!-- Add search form -->
            <div class="search-container">
                <form id="searchForm" onsubmit="handleSearch(event)">
                    <input type="text" id="searchInput" placeholder="Search products...">
                    <button type="submit" class="search-btn">Search</button>
                </form>
            </div>
            <nav>
                <ul id="MenuItems">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="">About</a></li>
                    <li><a href="">Contact</a></li>
                    <li><a href="userProfile.html">Profile</a></li>
                </ul>
            </nav>
            <a href="cart.html"><img src="../../images/cart.png" width="30px" height="30px"></a>
            <img src="images/menu.png" class="menu-icon" onclick="menutoggle()">
        </div>
    </div>

    <!-- Products section with sidebar -->
    <div class="small-container">
        <div class="row row-2">
            <h2>All Products</h2>
            <select id="sortSelect" onchange="handleSort()">
                <option value="default">Default Sort</option>
                <option value="price_asc">Price Low to High</option>
                <option value="price_desc">Price High to Low</option>
                <option value="rating">Sort By Rating</option>
            </select>
        </div>
        
        <div class="products-with-filter">
            <!-- Category Sidebar -->
            <div class="sidebar">
                <h3>Categories</h3>
                <div id="categoryList">
                    <!-- Categories will be populated dynamically -->
                </div>

                <!-- Add Price Range Filter -->
                <div class="price-filter">
                    <h3>Price Range</h3>
                    <div class="range-inputs">
                        <input type="range" id="minPrice" min="0" max="1000" value="100">
                        <input type="range" id="maxPrice" min="0" max="1000" value="900">
                        
                    </div>
                    <div class="price-inputs">
                        <div class="price-input-group">
                            <span>$</span>
                            <input type="number" 
                                   id="minPriceInput" 
                                   class="price-text-input" 
                                   placeholder="Min Price"
                                   step="0.01"
                                   oninput="adjustInputWidth(this)">
                        </div>
                        <div class="price-input-group">
                            <span>$</span>
                            <input type="number" 
                                   id="maxPriceInput" 
                                   class="price-text-input" 
                                   placeholder="Max Price"
                                   step="0.01"
                                   oninput="adjustInputWidth(this)">
                        </div>
                    </div>
                    <button class="apply-price" onclick="applyPriceFilter()">Apply</button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid">
                <div class="row" id="products-container"></div>
                <div class="page-btn" id="pagination">
                    <!-- Pagination will be added dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
      <div id="footer-bottom">
        <div class="container">
          <div class="row d-flex flex-wrap justify-content-between">
            <div class="col-md-4 col-sm-6">
              <div class="Shipping d-flex">
                <p>We ship with:</p>
                <div class="card-wrap ps-2">
                  <img src="images/dhl.png" alt="visa">
                  <img src="images/shippingcard.png" alt="mastercard">
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-6">
              <div class="payment-method d-flex">
                <p>Payment options:</p>
                <div class="card-wrap ps-2">
                  <img src="images/visa.jpg" alt="visa">
                  <img src="images/mastercard.jpg" alt="mastercard">
                  <img src="images/paypal.jpg" alt="paypal">
                </div>
              </div>
            </div>
            <div class="col-md-4 col-sm-6">
              <div class="copyright">
                <p>© Copyright 2025 ThunderStore.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

    <!-- javascript -->


    <script>

function showLoadingBar() {
    const loadingBar = document.getElementById('loadingBar');
    loadingBar.style.width = '0%';
    setTimeout(() => {
        loadingBar.style.width = '100%'; // Start filling the bar
    }, 10);
}

// Hide loading bar
function hideLoadingBar() {
    const loadingBar = document.getElementById('loadingBar');
    loadingBar.style.width = '0%'; // Hide it after the fetch completes
}

        var MenuItems = document.getElementById("MenuItems");
        MenuItems.style.maxHeight = "0px";
        function menutoggle() {
            if (MenuItems.style.maxHeight == "0px") {
                MenuItems.style.maxHeight = "200px"
            }
            else {
                MenuItems.style.maxHeight = "0px"
            }
        }

        let activeCategory = '';
        let searchTerm = '';

        // Add pagination variables
        let currentPage = 1;
        let totalPages = 1;

        // Update fetchCategories function
        async function fetchCategories() {
            try {
                const response = await fetch('http://localhost:3000/items/search');
                const data = await response.json();
                if (data.categories) {
                    displayCategories(data.categories);
                }
            } catch (error) {
                console.error('Error fetching categories:', error);
            }
        }

        // Update displayCategories function
        function displayCategories(categories) {
            const container = document.getElementById('categoryList');
            if (!container) return;
            
            container.innerHTML = `
                <div class="category-item ${activeCategory === '' ? 'active' : ''}" 
                     onclick="filterByCategory('')" 
                     role="button" 
                     tabindex="0">
                    All Categories
                </div>
                ${categories.map(cat => `
                    <div class="category-item ${activeCategory === cat ? 'active' : ''}" 
                         onclick="filterByCategory('${cat}')"
                         role="button"
                         tabindex="0">
                        ${cat}
                    </div>
                `).join('')}
            `;
        }

        // Update filterByCategory function
        async function filterByCategory(category) {
            activeCategory = category;
            currentPage = 1; // Reset to first page when changing category
            await fetchProducts();
            Array.from(document.getElementsByClassName('category-item')).forEach(item => {
                item.classList.remove('active');
                if ((category === '' && item.textContent.trim() === 'All Categories') ||
                    (item.textContent.trim() === category)) {
                    item.classList.add('active');
                }
            });
        }

        // Modify fetchProducts to handle pagination
        async function fetchProducts(queryString = '') {
            document.getElementById('loader').style.display = 'flex';

            try {
                
                let url = 'http://localhost:3000/items/search';
                if (!queryString) {
                    const params = new URLSearchParams();
                    if (searchTerm) params.append('name', searchTerm);
                    if (activeCategory) params.append('category', activeCategory);
                    params.append('page', currentPage);
                    queryString = '?' + params.toString();
                }
                
                const response = await fetch(url + queryString);
                const data = await response.json();
                displayProducts(data.items);
                updatePagination(data.pagination);
            } catch (error) {
                console.error('Error fetching products:', error);
            }
        finally {
            document.getElementById('loader').style.display = 'none'; // Hide loader
    }
            
        }

        function displayProducts(products) {
            const container = document.getElementById('products-container');
            const productDetailsPage = 'productDetailsPage.html';
            console.log(products[0]);
            container.innerHTML = products.map(product => 
           
            
            `
                <div class="col-4" onclick="window.location.href='${productDetailsPage}?id=${product.item_id}';">
                    <img src="${product.image}" alt="${product.item_name}" onerror="this.onerror=null;this.src='/images/a1.JPG';">
                    <h4>${product.item_name}</h4>
                    <div class="rating">
                        ${getStarRating(product.item_rating)}
                    </div>
                    <p>$${product.discount_price || product.actual_price}</p>
                    ${product.discount_price ? `<small><s>$${product.actual_price}</s></small>` : ''}
                </div>
            `).join('');
        }

        function getStarRating(rating) {
            const fullStars = Math.floor(rating || 0);
            let stars = '';
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    stars += '<i class="fa fa-star"></i>';
                } else {
                    stars += '<i class="fa fa-star-o"></i>';
                }
            }
            return stars;
        }

        async function handleSort() {
            const select = document.getElementById('sortSelect');
            const value = select.value;
            let params = new URLSearchParams(window.location.search);
            
            // Keep existing search and category filters
            if (searchTerm) {
                params.set('name', searchTerm);
            }
            if (activeCategory) {
                params.set('category', activeCategory);
            }

            // Add sort parameter
            switch(value) {
                case 'price_asc':
                    params.set('sort', 'price_asc');
                    break;
                case 'price_desc':
                    params.set('sort', 'price_desc');
                    break;
                case 'rating':
                    params.set('sort', 'rating');
                    break;
                default:
                    params.delete('sort');
            }
            
            await fetchProducts('?' + params.toString());
        }

        async function handleSearch(event) {
            event.preventDefault();
            searchTerm = document.getElementById('searchInput').value;
            await fetchProducts();
        }

        // Fix price range dragging
        function initPriceRange() {
            const minSlider = document.getElementById('minPrice');
            const maxSlider = document.getElementById('maxPrice');
            const minInput = document.getElementById('minPriceInput');
            const maxInput = document.getElementById('maxPriceInput');

            function updateMinRange(value) {
                const max = parseInt(maxSlider.value);
                value = Math.min(value, max);
                minSlider.value = value;
                minInput.value = value;
            }

            function updateMaxRange(value) {
                const min = parseInt(minSlider.value);
                value = Math.max(value, min);
                maxSlider.value = value;
                maxInput.value = value;
            }

            // Handle slider input
            minSlider.addEventListener('input', (e) => {
                updateMinRange(parseInt(e.target.value));
            });

            maxSlider.addEventListener('input', (e) => {
                updateMaxRange(parseInt(e.target.value));
            });

            // Handle manual input
            minInput.addEventListener('change', (e) => {
                updateMinRange(parseInt(e.target.value));
            });

            maxInput.addEventListener('change', (e) => {
                updateMaxRange(parseInt(e.target.value));
            });
        }

        async function applyPriceFilter() {
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            let params = new URLSearchParams();
            
            if (searchTerm) params.append('name', searchTerm);
            if (activeCategory) params.append('category', activeCategory);
            params.append('min_price', minPrice);
            params.append('max_price', maxPrice);
            
            await fetchProducts('?' + params.toString());
        }

        // Add these new functions
        async function updatePriceRange(category = '') {
            try {
                const response = await fetch(`http://localhost:3000/items/price-range${category ? `?category=${category}` : ''}`);
                const { min_price, max_price } = await response.json();
                
                const minSlider = document.getElementById('minPrice');
                const maxSlider = document.getElementById('maxPrice');
                const minInput = document.getElementById('minPriceInput');
                const maxInput = document.getElementById('maxPriceInput');

                // Update slider ranges and values
                const minVal = Math.floor(min_price);
                const maxVal = Math.ceil(max_price);

                // Update sliders
                minSlider.min = minVal;
                minSlider.max = maxVal;
                maxSlider.min = minVal;
                maxSlider.max = maxVal;
                
                // Set initial values
                minSlider.value = minVal;
                maxSlider.value = maxVal;
                minInput.value = minVal;
                maxInput.value = maxVal;

                // Setup input synchronization
                setupPriceInputSync(minSlider, maxSlider, minInput, maxInput);
            } catch (error) {
                console.error('Error updating price range:', error);
            }
        }

        function setupPriceInputSync(minSlider, maxSlider, minInput, maxInput) {
    // Slider to Input
    minSlider.oninput = () => {
        let minVal = Number(minSlider.value);
        let maxVal = Number(maxSlider.value);
        if (minVal >= maxVal) {
            minVal = maxVal - 1;
            minSlider.value = minVal;
        }
        minInput.value = minVal;
    };

    maxSlider.oninput = () => {
        let minVal = Number(minSlider.value);
        let maxVal = Number(maxSlider.value);
        if (maxVal <= minVal) {
            maxVal = minVal + 1;
            maxSlider.value = maxVal;
        }
        maxInput.value = maxVal;
    };

    // Input to Slider
    minInput.onchange = () => {
        let minVal = Number(minInput.value);
        let maxVal = Number(maxInput.value);
        if (minVal >= maxVal) {
            minVal = maxVal - 1;
            minInput.value = minVal;
        }
        minSlider.value = minVal;
    };

    maxInput.onchange = () => {
        let minVal = Number(minInput.value);
        let maxVal = Number(maxInput.value);
        if (maxVal <= minVal) {
            maxVal = minVal + 1;
            maxInput.value = maxVal;
        }
        maxSlider.value = maxVal;
    };
}


        function updatePagination(pagination) {
            const { currentPage, totalPages } = pagination;
            const container = document.getElementById('pagination');
            let html = '';
            
            // Previous page
            if (currentPage > 1) {
                html += `<span onclick="goToPage(${currentPage - 1})">←</span>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || 
                    i === totalPages || 
                    (i >= currentPage - 2 && i <= currentPage + 2)
                ) {
                    html += `<span class="${i === currentPage ? 'active' : ''}" 
                                  onclick="goToPage(${i})">${i}</span>`;
                } else if (
                    i === currentPage - 3 || 
                    i === currentPage + 3
                ) {
                    html += `<span class="dots">...</span>`;
                }
            }

            // Next page
            if (currentPage < totalPages) {
                html += `<span onclick="goToPage(${currentPage + 1})">→</span>`;
            }

            container.innerHTML = html;
        }

        async function goToPage(page) {
            currentPage = page;
            await fetchProducts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Modify document ready function
        document.addEventListener('DOMContentLoaded', () => {
            fetchCategories();
            fetchProducts();
            initPriceRange();
            updatePriceRange(); // Initialize price range for all categories
        });
    </script>

    <style>


            .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            }

            .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #778186;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            }

            @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
            }
        .page-btn {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }

        .page-btn span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid #000000;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn span.active {
            background: #000000;
            color: white;
        }

        .page-btn span:hover {
            background: #343131;
            color: white;
        }

        .page-btn span.dots {
            border: none;
            cursor: default;
        }

        .page-btn span.dots:hover {
            background: none;
            color: inherit;
        }
    </style>

</body>

</html>